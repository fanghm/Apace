<!DOCTYPE html>
<html lang="en">
<head>
  <title>Action Tracker</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/libs/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/libs/dataTables/css/jquery.dataTables.css">

  <script type="text/javascript" src="/libs/jquery.min.js"></script>
  <script type="text/javascript" src="/libs/bootstrap/js/bootstrap.min.js"></script>
  <script type="text/javascript" charset="utf8" src="/libs/dataTables/js/jquery.dataTables.js"></script>

  <script type="text/javascript" src="/libs/moment-with-locales.min.js"></script>
</head>
<body>
<script type="text/javascript">
  var action_map = {{{ json }}};
</script>

<div class="container">
  <h2>Action Tracker</h2>
  <p>Prototyping with DataTables</p>

  <p>
    <button type="button" class="updateModal btn btn-success pull-right" data-id="" data-toggle="modal" data-target="#editModal">
      <span class="glyphicon glyphicon-plus"></span> Add an action item
    </button>
  </p>

  <table class="table table-striped table-hover" id="tblAction">
    <thead>
      <tr>
        <th>#</th>
        <th>Action/Task</th>
        <th>Status</th>
        <th>Owner</th>
        <th>Create Time</th>
        <th>Last Update</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
    {{#each actions}}
      <tr id="{{_id}}">
        <td></td>
        <td>{{title}}</td>
        <td>{{status}}</td>
        <td>{{owner}}</td>
        <td>{{create_at_ago}}</td>
        <td>{{update_at_time}}</td>
        <td>
          <a class="updateModal btn btn-primary" data-id="{{_id}}" data-toggle="modal" data-target="#editModal">
            <span class="glyphicon glyphicon-edit"></span>
          </a>
        </td>
      </tr>
    {{/each}}
    </tbody>
  </table>
</div>

<!-- Common modal for add/edit an action item-->
<div id="editModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Add an action point</h4>
      </div>

      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="title">Action/Task:</label>
            <input class="form-control" id="title" required/>
          </div>

          <div class="form-group">
            <label for="desc">Description:</label>
            <textarea class="form-control" style="resize: vertical;max-height:400px; min-height:80px;" id="desc"></textarea>
          </div>

          <div class="form-group">
            <label for="category">Category:</label>
            <select class="form-control" id="category" required>
              <option value="" selected>-- Select --</option>
              <option value="CIF meeting">CIF meeting</option>
              <option value="RCA/EDA">RCA/EDA</option>
              <option value="Retrospective">Retrospective</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="le">LE:</label>
            <input type="date" class="form-control" id="le"/>
          </div>

          <div class="form-group">
            <label for="optradio">Status:</label><br>
            <label class="radio-inline"><input type="radio" name="status" value='New' checked>New</label>
            <label class="radio-inline"><input type="radio" name="status" value='Ongoing'>Ongoing</label>
            <label class="radio-inline"><input type="radio" name="status" value='Done'>Done</label>
            <label class="radio-inline"><input type="radio" name="status" value='Cancelled'>Cancelled</label>
            <label class="radio-inline"><input type="radio" name="status" value='Blocked'>Blocked</label>
            <label class="radio-inline"><input type="radio" name="status" value='Suspended'>Suspended</label>
          </div>

          <div class="form-group">
            <label for="owner">Owner:</label>
            <input class="form-control" id="owner"/>
          </div>

          <div id="grp_history" class="form-group" style="display:none;">
            <label for="history">History:</label>
            <textarea class="form-control" style="resize: vertical;max-height:400px; min-height:100px;" rows="5" id="history"></textarea>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button id="deleteAction" type="button" class="btn btn-danger" style="display:none;">Delete</button>
        <button id="saveAction" type="button" class="btn btn-success">Save</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

  $(document).ready( function () {
    var t = $('#tblAction').DataTable( {
      "columnDefs": [ {
          "searchable": false,
          "orderable": false,
          "targets": 0
        } ],
      //"order": [[ 1, 'asc' ]]
    });

    t.on( 'order.dt search.dt', function () {
      t.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
          cell.innerHTML = i+1;
      } );
    } ).draw();

    // Triggered when modal is about to be shown
    $('.updateModal').on('show.bs.modal', function(e) {
        $('#title').focus();
    });

    $('.updateModal').on( 'click', function () {
      //console.log('action_map: ' + JSON.stringify(action_map) );

      var dataId = $(this).data('id');  // todo: WHY THIS DOESN'T WORK!!!
      if (dataId !== "") {  // edit
        console.log('update action: ' + JSON.stringify(action_map[dataId]) );

        var row = $(this).closest("tr").find("td:nth-child(1)").text();
        //console.log("row index: " + row);

        $(".modal-title").text( 'Edit an action point' );

        // distinguish add/edit
        $(".modal-footer #saveAction").data("id", dataId);
        $(".modal-footer #saveAction").data("row", row);

        // set data-id attr for deletion from db, set data-row for deletion from view
        $(".modal-footer #deleteAction").data("id", dataId);
        $(".modal-footer #deleteAction").data("row", row);
        //console.log("#deleteAction.data-id:" + $(".modal-footer #deleteAction").data("id"));
        //console.log("#deleteAction.data-row:" + $(".modal-footer #deleteAction").data("row"));

        $("#deleteAction").show();
        $("#grp_history").show();

        $('.modal-body #category').val( action_map[dataId].category );
        $(".modal-body #title").val( action_map[dataId].title );
        $(".modal-body #desc").val( action_map[dataId].desc );
        $(".modal-body #owner").val( action_map[dataId].owner );
        $(".modal-body #history").val( action_map[dataId].history );
        $("input[name=status][value=" + action_map[dataId].status + "]").attr('checked', 'checked');
      } else {  // add
        $("#deleteAction").hide();
        $("#grp_history").hide();

        $('.modal-body #category').val("");
        $(".modal-body #title").val("");
        $(".modal-body #desc").val("");
        $(".modal-body #owner").val("");
        $(".modal-body #history").val("");
        $("input[name=status][value='New']").attr('checked', 'checked');
      }

    });

    $('#deleteAction').on( 'click', function () {
      var dataId = $(this).data('id');
      //console.log("onclick #deleteAction.data-id:" + dataId);

      var yes = confirm('Are you sure you want to delete this action?');
      if (yes) {
        $.ajax({
          type: 'DELETE',
          url: '/delete/' + dataId
        }).done(function( res ) {
          if (res.msg === '') {
            //console.log("deleted");
            t.row($(this).data('row')).remove().draw( false );  // draw(false): redraw the table keeping the current paging
          } else {
            alert('Error: ' + res.msg);
          }
        });
      } else {
        return false;
      }

    });

    $('#saveAction').on( 'click', function () {
      var data = {
        title:    $('#title').val(),
        desc:     $('#desc').val(),
        category: $('#category').val(),
        le:       $('#le').val(),
        status:   $('input[name=status]:checked').val(),
        owner:    $('#owner').val(),
        history:  $('#history').val(),
      };

      var addAction = true;
      var url = '/add';
      var method = 'POST';

      var row = $(this).data('row');
      var dataId = $(this).data("id");// $(".modal-footer #saveAction").data("id");

      if (dataId != "") {
        addAction = false;
        url = '/update/' + dataId;
        method = 'PUT';
      }

      $.ajax({
        url: url,
        dataType: 'json',
        type: method,
        contentType: 'application/json',
        data: JSON.stringify(data),

        success: function(action, textStatus, jQxhr) {
          console.log('success');
          //console.log('client:' + JSON.stringify(action));
          if (addAction) {  // add
            moment.locale('zh-cn');

            t.row.add( [
              '',
              action.title,
              action.status,
              action.owner,
              moment(action.create_at).fromNow(),
              moment(action.update_at).format('YYYY-MM-DD HH:mm'),
              '<a class="updateModal btn btn-primary" data-id="' + data._id + '" data-toggle="modal" data-target="#editModal"> <span class="glyphicon glyphicon-edit"></span> </a>'
            ] ).draw( false );
          } else {  // update
            // TODO: refresh row, update client, and action_map (in case of later update as we read data from it)
            //var tr = $('#tblAction tbody tr').eq(row);
            var tr = $('#' + dataId);
            console.log('row:' + row + ', tr:' + tr.html());
            tr.find('td:eq(1)').html( action.title ); // col 2
            tr.find("td:nth-child(3)").html( action.status ); // col 3
            console.log('td1:' + tr.find('td:eq(1)').html());

            t.row(tr).invalidate().draw(false);
            console.log('updated tr:' + $('#' + dataId).html());  // undefined when no visible in current page

            action_map[dataId] = action;
          }

          $('.updateModal').modal('hide');
        },
        error: function( jqXhr, textStatus, errorThrown ){
            console.log( errorThrown );
        }
      });

    } );  // end of onclick

  } );

</script>
</body>
</html>